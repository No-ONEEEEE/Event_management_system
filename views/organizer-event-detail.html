<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Details - Event Management System</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    nav {
      background: white;
      padding: 15px 30px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    nav .logo {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }
    nav ul {
      list-style: none;
      display: flex;
      gap: 20px;
    }
    nav a {
      text-decoration: none;
      color: #333;
      font-weight: 500;
      transition: color 0.3s;
    }
    nav a:hover {
      color: #667eea;
    }
    nav a.logout-link {
      color: #dc3545;
    }
    nav a.logout-link:hover {
      color: #c82333;
    }
    .container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 0 20px;
    }
    .section {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    .section h2 {
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }
    .overview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }
    .overview-item {
      padding: 15px;
      background: #f9f9f9;
      border-radius: 5px;
    }
    .overview-item label {
      display: block;
      color: #666;
      font-size: 14px;
      margin-bottom: 5px;
    }
    .overview-item .value {
      color: #333;
      font-size: 16px;
      font-weight: bold;
    }
    .badge {
      display: inline-block;
      padding: 6px 14px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: bold;
    }
    .badge.draft { background: #ffd93d; color: #333; }
    .badge.published { background: #6bcf7f; color: white; }
    .badge.ongoing { background: #4d9de0; color: white; }
    .badge.completed { background: #888; color: white; }
    .badge.closed { background: #e15554; color: white; }
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .analytics-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .analytics-card h3 {
      font-size: 32px;
      margin-bottom: 10px;
    }
    .analytics-card p {
      font-size: 14px;
      opacity: 0.9;
    }
    .participants-section {
      margin-top: 20px;
    }
    .search-filter-bar {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .search-filter-bar input {
      flex: 1;
      min-width: 200px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .search-filter-bar select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .participants-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      overflow-x: auto;
    }
    .participants-table th {
      background: #667eea;
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: bold;
    }
    .participants-table td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
    }
    .participants-table tr:hover {
      background: #f5f5f5;
    }
    .btn {
      display: inline-block;
      padding: 10px 20px;
      background: #667eea;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    .btn:hover {
      background: #5568d3;
    }
    .btn-secondary {
      background: #888;
    }
    .btn-secondary:hover {
      background: #777;
    }
    .btn-success {
      background: #6bcf7f;
    }
    .btn-success:hover {
      background: #5ab86d;
    }
    .btn-danger {
      background: #e15554;
    }
    .btn-danger:hover {
      background: #d04544;
    }
    .actions {
      margin-bottom: 20px;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #667eea;
      font-size: 18px;
    }
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 12px;
      font-weight: bold;
    }
    .status-badge.registered { background: #6bcf7f; color: white; }
    .status-badge.completed { background: #888; color: white; }
    .status-badge.cancelled { background: #e15554; color: white; }
    .status-badge.paid { background: #6bcf7f; color: white; }
    .status-badge.pending { background: #ffd93d; color: #333; }
    .btn-small {
      padding: 6px 12px;
      font-size: 13px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .btn-small:hover {
      background: #5568d3;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }
    .modal-content {
      background: white;
      margin: 50px auto;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #667eea;
    }
    .modal-header h3 {
      color: #333;
      margin: 0;
    }
    .close {
      font-size: 28px;
      font-weight: bold;
      color: #aaa;
      cursor: pointer;
      background: none;
      border: none;
    }
    .close:hover {
      color: #000;
    }
    .detail-row {
      margin-bottom: 15px;
      padding: 10px;
      background: #f9f9f9;
      border-radius: 5px;
    }
    .detail-row label {
      display: block;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 5px;
    }
    .detail-row .value {
      color: #333;
    }
  </style>
</head>
<body>
  <nav>
    <div class="logo">Event Manager</div>
    <ul>
      <li><a href="/organizer/dashboard">Dashboard</a></li>
      <li><a href="/organizer/create-event">Create Event</a></li>
      <li><a href="/organizer/ongoing-events">Ongoing Events</a></li>
      <li><a href="/organizer/profile">Profile</a></li>
      <li><a href="#" class="logout-link" onclick="logout()">Logout</a></li>
    </ul>
  </nav>

  <div class="container">
    <div id="loading" class="loading">Loading event details...</div>

    <div id="content" style="display: none;">
      <!-- Event Overview -->
      <div class="section">
        <h2 id="eventTitle">Event Overview</h2>
        
        <div class="actions">
          <a href="#" id="editBtn" class="btn">Edit Event</a>
          <a href="#" id="scannerBtn" class="btn btn-success" style="display: none;">ðŸ“· QR Scanner</a>
          <button id="closeRegBtn" class="btn btn-danger" onclick="closeRegistrations()" style="display: none;">Close Registrations</button>
          <button class="btn btn-secondary" onclick="changeStatus()">Change Status</button>
          <a href="/organizer/dashboard" class="btn btn-secondary">Back to Dashboard</a>
        </div>

        <div class="overview-grid" id="overviewGrid">
          <!-- Overview items will be loaded here -->
        </div>
      </div>

      <!-- Analytics -->
      <div class="section">
        <h2>Event Analytics</h2>
        
        <div class="analytics-grid">
          <div class="analytics-card">
            <h3 id="totalRegs">0</h3>
            <p>Total Registrations</p>
          </div>
          <div class="analytics-card">
            <h3 id="salesCount">0</h3>
            <p>Completed Sales</p>
          </div>
          <div class="analytics-card">
            <h3 id="attendanceCount">0</h3>
            <p>Attendance</p>
          </div>
          <div class="analytics-card">
            <h3 id="revenueAmount">â‚¹0</h3>
            <p>Total Revenue</p>
          </div>
        </div>

        <div style="margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 5px;">
          <p><strong>Team Completion:</strong> <span id="teamCompletion">N/A</span></p>
          <p style="margin-top: 10px;"><strong>Status Breakdown:</strong></p>
          <ul id="statusBreakdown" style="margin-top: 5px; list-style: none; padding: 0;">
            <!-- Status breakdown will be loaded here -->
          </ul>
        </div>
      </div>

      <!-- Participants List -->
      <div class="section">
        <h2>Participants</h2>
        
        <div class="participants-section">
          <div class="search-filter-bar">
            <input type="text" id="searchInput" placeholder="Search by name, email, ticket ID..." onkeyup="filterParticipants()">
            <select id="statusFilter" onchange="filterParticipants()">
              <option value="">All Statuses</option>
              <option value="Registered">Registered</option>
              <option value="Completed">Completed</option>
              <option value="Cancelled">Cancelled</option>
              <option value="Rejected">Rejected</option>
            </select>
            <select id="paymentFilter" onchange="filterParticipants()">
              <option value="">All Payments</option>
              <option value="Completed">Paid</option>
              <option value="Pending">Pending</option>
            </select>
            <button class="btn" onclick="exportCSV()">Export CSV</button>
          </div>

          <div style="overflow-x: auto;">
            <table class="participants-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Contact</th>
                  <th>Registration Date</th>
                  <th>Payment</th>
                  <th>Team</th>
                  <th>Attendance</th>
                  <th>Status</th>
                  <th>Ticket ID</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="participantsTable">
                <!-- Participants will be loaded here -->
              </tbody>
            </table>
          </div>

          <div id="noParticipants" class="empty-state" style="display: none;">
            No participants registered yet.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Participant Details Modal -->
  <div id="participantModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Participant Details</h3>
        <button class="close" onclick="closeParticipantModal()">&times;</button>
      </div>
      <div id="participantDetails">
        <!-- Details will be loaded here -->
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:5000/api';
    const token = localStorage.getItem('token');
    let eventData = null;
    let participants = [];
    let filteredParticipants = [];

    if (!token) {
      window.location.href = '/auth/login';
    }

    // Get event ID from URL
    const eventId = window.location.pathname.split('/').pop();

    async function loadEventDetails() {
      try {
        const response = await fetch(`${API_URL}/organizers/events/${eventId}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.status === 401 || response.status === 403) {
          logout();
          return;
        }

        const data = await response.json();
        eventData = data.event;
        participants = data.participants || [];
        filteredParticipants = participants;

        // Render event overview
        document.getElementById('eventTitle').textContent = eventData.eventName;
        
        const overviewHTML = `
          <div class="overview-item">
            <label>Status</label>
            <div class="value"><span class="badge ${eventData.status.toLowerCase()}">${eventData.status}</span></div>
          </div>
          <div class="overview-item">
            <label>Type</label>
            <div class="value">${eventData.eventType}</div>
          </div>
          <div class="overview-item">
            <label>Start Date</label>
            <div class="value">${new Date(eventData.eventStartDate).toLocaleString()}</div>
          </div>
          <div class="overview-item">
            <label>End Date</label>
            <div class="value">${new Date(eventData.eventEndDate).toLocaleString()}</div>
          </div>
          <div class="overview-item">
            <label>Registration Deadline</label>
            <div class="value">${new Date(eventData.registrationDeadline).toLocaleString()}</div>
          </div>
          <div class="overview-item">
            <label>Eligibility</label>
            <div class="value">${eventData.eligibility || 'Any'}</div>
          </div>
          <div class="overview-item">
            <label>Registration Fee</label>
            <div class="value">â‚¹${eventData.registrationFee || 0}</div>
          </div>
          <div class="overview-item">
            <label>Registration Limit</label>
            <div class="value">${eventData.registrationLimit || 'Unlimited'}</div>
          </div>
          ${eventData.venue ? `
          <div class="overview-item">
            <label>Venue</label>
            <div class="value">${eventData.venue}</div>
          </div>
          ` : ''}
        `;
        document.getElementById('overviewGrid').innerHTML = overviewHTML;

        // Set edit button
        if (eventData.status === 'Draft' || eventData.status === 'Published') {
          document.getElementById('editBtn').href = `/organizer/create-event?id=${eventId}`;
        } else {
          document.getElementById('editBtn').style.display = 'none';
        }

        // Show close registrations button for published events
        if (eventData.status === 'Published') {
          document.getElementById('closeRegBtn').style.display = 'inline-block';
        }

        // Show QR scanner button for published and ongoing events
        if (eventData.status === 'Published' || eventData.status === 'Ongoing') {
          const scannerBtn = document.getElementById('scannerBtn');
          scannerBtn.href = `/organizer/attendance/${eventId}`;
          scannerBtn.style.display = 'inline-block';
        }

        // Render analytics
        document.getElementById('totalRegs').textContent = data.analytics.totalRegistrations;
        document.getElementById('salesCount').textContent = data.analytics.salesCount;
        document.getElementById('attendanceCount').textContent = data.analytics.attendance;
        document.getElementById('revenueAmount').textContent = `â‚¹${data.analytics.revenue}`;
        document.getElementById('teamCompletion').textContent = data.analytics.teamCompletion;

        const statusBreakdownHTML = Object.entries(data.analytics.statusBreakdown)
          .map(([status, count]) => `<li><strong>${status}:</strong> ${count}</li>`)
          .join('');
        document.getElementById('statusBreakdown').innerHTML = statusBreakdownHTML;

        // Render participants
        renderParticipants();

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';

      } catch (error) {
        console.error('Error loading event:', error);
        alert('Error loading event details');
      }
    }

    function renderParticipants() {
      const tbody = document.getElementById('participantsTable');
      const noParticipants = document.getElementById('noParticipants');

      if (filteredParticipants.length === 0) {
        tbody.innerHTML = '';
        noParticipants.style.display = 'block';
        return;
      }

      noParticipants.style.display = 'none';

      const html = filteredParticipants.map(p => `
        <tr>
          <td>${p.name}</td>
          <td>${p.email}</td>
          <td>${p.contactNumber || 'N/A'}</td>
          <td>${new Date(p.registrationDate).toLocaleDateString()}</td>
          <td><span class="status-badge ${p.paymentStatus.toLowerCase()}">${p.paymentStatus}</span></td>
          <td>${p.team}${p.teamMembers && p.teamMembers.length > 0 ? ` (${p.teamMembers.length} members)` : ''}</td>
          <td>${p.attendance ? 'Yes' : 'No'}</td>
          <td><span class="status-badge ${p.status.toLowerCase()}">${p.status}</span></td>
          <td>${p.ticketId}</td>
          <td><button class="btn-small" onclick='viewParticipantDetails(${JSON.stringify(p)})'>View Details</button></td>
        </tr>
      `).join('');

      tbody.innerHTML = html;
    }

    function filterParticipants() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const paymentFilter = document.getElementById('paymentFilter').value;

      filteredParticipants = participants.filter(p => {
        const matchesSearch = !searchTerm || 
          p.name.toLowerCase().includes(searchTerm) ||
          p.email.toLowerCase().includes(searchTerm) ||
          p.ticketId.toLowerCase().includes(searchTerm);

        const matchesStatus = !statusFilter || p.status === statusFilter;
        const matchesPayment = !paymentFilter || p.paymentStatus === paymentFilter;

        return matchesSearch && matchesStatus && matchesPayment;
      });

      renderParticipants();
    }

    async function exportCSV() {
      try {
        const response = await fetch(`${API_URL}/organizers/events/${eventId}/export-csv`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${eventData.eventName}_participants.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
      } catch (error) {
        alert('Error exporting CSV: ' + error.message);
      }
    }

    async function closeRegistrations() {
      if (!confirm('Are you sure you want to close registrations for this event?')) {
        return;
      }

      try {
        const response = await fetch(`${API_URL}/organizers/events/${eventId}/close-registrations`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        const data = await response.json();

        if (response.ok) {
          alert('Registrations closed successfully');
          location.reload();
        } else {
          alert(data.message);
        }
      } catch (error) {
        alert('Error closing registrations: ' + error.message);
      }
    }

    async function changeStatus() {
      const newStatus = prompt('Enter new status (Draft/Published/Ongoing/Completed/Closed):');
      
      if (!newStatus) return;

      const validStatuses = ['Draft', 'Published', 'Ongoing', 'Completed', 'Closed'];
      if (!validStatuses.includes(newStatus)) {
        alert('Invalid status. Valid options: Draft, Published, Ongoing, Completed, Closed');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/organizers/events/${eventId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ status: newStatus })
        });

        const data = await response.json();

        if (response.ok) {
          alert('Status changed successfully');
          location.reload();
        } else {
          alert(data.message);
        }
      } catch (error) {
        alert('Error changing status: ' + error.message);
      }
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('token');
        localStorage.removeItem('userType');
        window.location.href = '/auth/login';
      }
    }

    function viewParticipantDetails(participant) {
      const modal = document.getElementById('participantModal');
      const detailsDiv = document.getElementById('participantDetails');

      let html = `
        <div class="detail-row">
          <label>Name:</label>
          <div class="value">${participant.name}</div>
        </div>
        <div class="detail-row">
          <label>Email:</label>
          <div class="value">${participant.email}</div>
        </div>
        <div class="detail-row">
          <label>Contact Number:</label>
          <div class="value">${participant.contactNumber || 'N/A'}</div>
        </div>
        <div class="detail-row">
          <label>Registration Date:</label>
          <div class="value">${new Date(participant.registrationDate).toLocaleString()}</div>
        </div>
        <div class="detail-row">
          <label>Payment Status:</label>
          <div class="value"><span class="status-badge ${participant.paymentStatus.toLowerCase()}">${participant.paymentStatus}</span></div>
        </div>
        <div class="detail-row">
          <label>Status:</label>
          <div class="value"><span class="status-badge ${participant.status.toLowerCase()}">${participant.status}</span></div>
        </div>
        <div class="detail-row">
          <label>Ticket ID:</label>
          <div class="value">${participant.ticketId}</div>
        </div>
      `;

      // Show team information if exists
      if (participant.team && participant.team !== 'Individual') {
        html += `
          <div class="detail-row">
            <label>Team Name:</label>
            <div class="value">${participant.team}</div>
          </div>
        `;
        
        if (participant.teamMembers && participant.teamMembers.length > 0) {
          html += `
            <div class="detail-row">
              <label>Team Members:</label>
              <div class="value">
          `;
          participant.teamMembers.forEach(member => {
            html += `<div style="margin: 5px 0;">
              ${member.name || 'N/A'} - ${member.email || 'N/A'}
              ${member.rollNumber ? ` (${member.rollNumber})` : ''}
            </div>`;
          });
          html += `</div></div>`;
        }
      }

      // Show form responses if exists
      if (participant.formResponses && Array.isArray(participant.formResponses) && participant.formResponses.length > 0) {
        html += `
          <div class="detail-row">
            <label style="color: #e15554; font-size: 16px; margin-top: 10px;">Custom Form Responses:</label>
          </div>
        `;
        participant.formResponses.forEach(response => {
          html += `
            <div class="detail-row">
              <label>${response.fieldLabel}:</label>
              <div class="value">${response.fieldValue || 'N/A'}</div>
            </div>
          `;
        });
      } else {
        html += `
          <div class="detail-row">
            <label>Form Responses:</label>
            <div class="value" style="color: #999;">No additional form data submitted</div>
          </div>
        `;
      }

      detailsDiv.innerHTML = html;
      modal.style.display = 'block';
    }

    function closeParticipantModal() {
      document.getElementById('participantModal').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('participantModal');
      if (event.target === modal) {
        closeParticipantModal();
      }
    }

    // Load event details on page load
    loadEventDetails();
  </script>
</body>
</html>
