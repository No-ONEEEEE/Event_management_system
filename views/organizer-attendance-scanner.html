<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance Scanner - Event Management System</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    nav {
      background: white;
      padding: 15px 30px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    nav .logo {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }
    nav ul {
      list-style: none;
      display: flex;
      gap: 20px;
    }
    nav a {
      text-decoration: none;
      color: #333;
      font-weight: 500;
      transition: color 0.3s;
    }
    nav a:hover {
      color: #667eea;
    }
    nav a.logout-link {
      color: #dc3545;
    }
    nav a.logout-link:hover {
      color: #c82333;
    }
    .container {
      max-width: 1400px;
      margin: 30px auto;
      padding: 0 20px;
    }
    .section {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    .section h2 {
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #667eea;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    .stat-card h3 {
      font-size: 36px;
      margin-bottom: 5px;
    }
    .stat-card p {
      opacity: 0.9;
      font-size: 14px;
    }
    .scanner-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }
    .scanner-box {
      border: 2px dashed #667eea;
      border-radius: 10px;
      padding: 20px;
      text-align: center;
    }
    #qr-reader {
      max-width: 500px;
      margin: 20px auto;
    }
    .btn {
      display: inline-block;
      padding: 12px 24px;
      background: #667eea;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
      margin: 10px 5px;
    }
    .btn:hover {
      background: #5568d3;
    }
    .btn-success {
      background: #6bcf7f;
    }
    .btn-success:hover {
      background: #5ab86d;
    }
    .btn-danger {
      background: #e15554;
    }
    .btn-danger:hover {
      background: #d04544;
    }
    .btn-secondary {
      background: #888;
    }
    .btn-secondary:hover {
      background: #777;
    }
    .table-container {
      overflow-x: auto;
      margin-top: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    th {
      background: #667eea;
      color: white;
      padding: 12px;
      text-align: left;
      font-weight: bold;
    }
    td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
    }
    tr:hover {
      background: #f5f5f5;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 12px;
      font-weight: bold;
    }
    .badge-present {
      background: #6bcf7f;
      color: white;
    }
    .badge-absent {
      background: #e15554;
      color: white;
    }
    .badge-qr {
      background: #4d9de0;
      color: white;
    }
    .badge-manual {
      background: #ffd93d;
      color: #333;
    }
    .scan-result {
      margin: 20px 0;
      padding: 15px;
      border-radius: 5px;
      display: none;
    }
    .scan-result.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .scan-result.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .scan-result.duplicate {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .manual-override-form {
      display: none;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 5px;
      margin: 20px 0;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    #fileUpload {
      margin: 20px 0;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #667eea;
      font-size: 18px;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #ddd;
    }
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      background: none;
      border: none;
      font-size: 16px;
      font-weight: bold;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }
    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .refresh-badge {
      display: inline-block;
      background: #6bcf7f;
      color: white;
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 12px;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <nav>
    <div class="logo">Event Manager</div>
    <ul>
      <li><a href="/organizer/dashboard">Dashboard</a></li>
      <li><a href="/organizer/create-event">Create Event</a></li>
      <li><a href="/organizer/ongoing-events">Ongoing Events</a></li>
      <li><a href="/organizer/profile">Profile</a></li>
      <li><a href="#" class="logout-link" onclick="logout()">Logout</a></li>
    </ul>
  </nav>

  <div class="container">
    <div id="loading" class="loading">Loading event details...</div>

    <div id="content" style="display: none;">
      <!-- Header -->
      <div class="section">
        <h2 id="eventTitle">QR Scanner & Attendance Tracking</h2>
        <div>
          <a href="/organizer/ongoing-events" class="btn btn-secondary">Back to Ongoing Events</a>
          <button class="btn btn-success" onclick="exportAttendanceCSV()">üì• Export Attendance CSV</button>
          <button class="btn" onclick="refreshDashboard()">üîÑ Refresh</button>
        </div>
      </div>

      <!-- Statistics -->
      <div class="section">
        <h2>Live Attendance Statistics <span class="refresh-badge" id="lastUpdate">Live</span></h2>
        <div class="stats-grid">
          <div class="stat-card">
            <h3 id="totalRegistrations">0</h3>
            <p>Total Registrations</p>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #6bcf7f 0%, #5ab86d 100%);">
            <h3 id="scannedCount">0</h3>
            <p>Scanned (Present)</p>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #e15554 0%, #d04544 100%);">
            <h3 id="notScannedCount">0</h3>
            <p>Not Yet Scanned</p>
          </div>
          <div class="stat-card" style="background: linear-gradient(135deg, #4d9de0 0%, #3d8dd0 100%);">
            <h3 id="attendanceRate">0%</h3>
            <p>Attendance Rate</p>
          </div>
        </div>
      </div>

      <!-- QR Scanner Section -->
      <div class="section">
        <h2>Scan QR Codes</h2>
        
        <div class="scanner-container">
          <!-- Camera Scanner -->
          <div class="scanner-box">
            <h3 style="margin-bottom: 15px;">üì∑ Camera Scanner</h3>
            <button class="btn btn-success" id="startScanBtn" onclick="startScanner()">Start Camera</button>
            <button class="btn btn-danger" id="stopScanBtn" onclick="stopScanner()" style="display: none;">Stop Camera</button>
            <div id="qr-reader"></div>
          </div>

          <!-- File Upload Scanner -->
          <div class="scanner-box">
            <h3 style="margin-bottom: 15px;">üìÅ Upload QR Code Image</h3>
            <p style="color: #666; margin-bottom: 15px;">Upload a screenshot or photo of the QR code</p>
            <input type="file" id="fileUpload" accept="image/*" onchange="scanFromFile(this)">
          </div>
        </div>

        <!-- Scan Result -->
        <div id="scanResult" class="scan-result"></div>

        <!-- Manual Override -->
        <div style="margin-top: 20px;">
          <button class="btn btn-secondary" onclick="toggleManualOverride()">‚úã Manual Override</button>
        </div>

        <div id="manualOverrideForm" class="manual-override-form">
          <h3 style="margin-bottom: 15px;">Manual Attendance Override</h3>
          <p style="color: #856404; background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
            ‚ö†Ô∏è This option is for exceptional cases only. All manual overrides are logged for audit purposes.
          </p>
          <div class="form-group">
            <label>Ticket ID *</label>
            <input type="text" id="manualTicketId" placeholder="Enter ticket ID (e.g., TKT-12345-ABC)" required>
          </div>
          <div class="form-group">
            <label>Reason/Notes *</label>
            <textarea id="manualNotes" rows="3" placeholder="Enter reason for manual override..." required></textarea>
          </div>
          <button class="btn btn-success" onclick="submitManualAttendance()">Mark Attendance</button>
          <button class="btn btn-secondary" onclick="toggleManualOverride()">Cancel</button>
        </div>
      </div>

      <!-- Attendance Dashboard -->
      <div class="section">
        <h2>Attendance Dashboard</h2>

        <div class="tabs">
          <button class="tab active" onclick="switchTab('scanned')">‚úÖ Scanned (<span id="scannedTabCount">0</span>)</button>
          <button class="tab" onclick="switchTab('not-scanned')">‚è≥ Not Yet Scanned (<span id="notScannedTabCount">0</span>)</button>
        </div>

        <!-- Scanned Participants -->
        <div id="scanned-tab" class="tab-content active">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Ticket ID</th>
                  <th>Scan Time</th>
                  <th>Method</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="scannedTable">
                <tr>
                  <td colspan="6" style="text-align: center; color: #999;">No participants scanned yet</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Not Scanned Participants -->
        <div id="not-scanned-tab" class="tab-content">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Ticket ID</th>
                  <th>Contact Number</th>
                  <th>Quick Action</th>
                </tr>
              </thead>
              <tbody id="notScannedTable">
                <tr>
                  <td colspan="5" style="text-align: center; color: #999;">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:5000/api';
    const token = localStorage.getItem('token');
    let eventId = null;
    let html5QrCode = null;
    let attendanceData = null;
    let autoRefreshInterval = null;

    if (!token) {
      window.location.href = '/auth/login';
    }

    // Get event ID from URL
    const urlPath = window.location.pathname;
    eventId = urlPath.split('/').pop();

    async function loadEventDetails() {
      try {
        const response = await fetch(`${API_URL}/organizers/events/${eventId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          throw new Error('Failed to load event');
        }

        const data = await response.json();
        document.getElementById('eventTitle').textContent = `QR Scanner - ${data.event.eventName}`;
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';

        // Load attendance dashboard
        await refreshDashboard();

        // Auto-refresh every 10 seconds
        autoRefreshInterval = setInterval(refreshDashboard, 10000);
      } catch (error) {
        alert('Error loading event: ' + error.message);
        window.location.href = '/organizer/ongoing-events';
      }
    }

    async function refreshDashboard() {
      try {
        const response = await fetch(`${API_URL}/organizers/events/${eventId}/attendance-dashboard`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        attendanceData = await response.json();

        // Update statistics
        document.getElementById('totalRegistrations').textContent = attendanceData.totalRegistrations;
        document.getElementById('scannedCount').textContent = attendanceData.scannedCount;
        document.getElementById('notScannedCount').textContent = attendanceData.notScannedCount;
        document.getElementById('attendanceRate').textContent = attendanceData.attendanceRate + '%';
        document.getElementById('scannedTabCount').textContent = attendanceData.scannedCount;
        document.getElementById('notScannedTabCount').textContent = attendanceData.notScannedCount;

        // Update last refresh time
        const now = new Date();
        document.getElementById('lastUpdate').textContent = `Updated ${now.toLocaleTimeString()}`;

        // Render tables
        renderScannedTable();
        renderNotScannedTable();
      } catch (error) {
        console.error('Error refreshing dashboard:', error);
      }
    }

    function renderScannedTable() {
      const tbody = document.getElementById('scannedTable');
      
      if (attendanceData.scanned.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999;">No participants scanned yet</td></tr>';
        return;
      }

      const html = attendanceData.scanned.map(p => `
        <tr>
          <td>${p.name}</td>
          <td>${p.email}</td>
          <td><span class="badge badge-present">${p.ticketId}</span></td>
          <td>${new Date(p.scanTime).toLocaleString()}</td>
          <td><span class="badge ${p.method === 'QR_SCAN' ? 'badge-qr' : 'badge-manual'}">${p.method === 'QR_SCAN' ? 'QR Scan' : 'Manual'}</span></td>
          <td>${p.notes || '-'}</td>
        </tr>
      `).join('');

      tbody.innerHTML = html;
    }

    function renderNotScannedTable() {
      const tbody = document.getElementById('notScannedTable');
      
      if (attendanceData.notScanned.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">All participants have been scanned!</td></tr>';
        return;
      }

      const html = attendanceData.notScanned.map(p => `
        <tr>
          <td>${p.name}</td>
          <td>${p.email}</td>
          <td><span class="badge badge-absent">${p.ticketId}</span></td>
          <td>${p.contactNumber || 'N/A'}</td>
          <td><button class="btn" style="padding: 6px 12px; font-size: 12px;" onclick="quickManualMark('${p.ticketId}')">Mark Present</button></td>
        </tr>
      `).join('');

      tbody.innerHTML = html;
    }

    function switchTab(tab) {
      // Update tab buttons
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      // Update tab content
      document.getElementById('scanned-tab').classList.remove('active');
      document.getElementById('not-scanned-tab').classList.remove('active');
      
      if (tab === 'scanned') {
        document.getElementById('scanned-tab').classList.add('active');
      } else {
        document.getElementById('not-scanned-tab').classList.add('active');
      }
    }

    function startScanner() {
      html5QrCode = new Html5Qrcode("qr-reader");
      
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: { width: 250, height: 250 } },
        (decodedText) => {
          // QR code successfully scanned
          processQRScan(decodedText);
        },
        (errorMessage) => {
          // Ignore errors during scanning
        }
      ).then(() => {
        document.getElementById('startScanBtn').style.display = 'none';
        document.getElementById('stopScanBtn').style.display = 'inline-block';
      }).catch((err) => {
        alert('Unable to start camera: ' + err);
      });
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          document.getElementById('startScanBtn').style.display = 'inline-block';
          document.getElementById('stopScanBtn').style.display = 'none';
        });
      }
    }

    async function scanFromFile(input) {
      if (!input.files || !input.files[0]) return;

      const file = input.files[0];
      
      if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("qr-reader");
      }

      try {
        const decodedText = await html5QrCode.scanFile(file, true);
        processQRScan(decodedText);
      } catch (err) {
        showScanResult('error', 'Unable to scan QR code from image. Please try again or use camera scanner.');
      }
      
      // Reset file input
      input.value = '';
    }

    async function processQRScan(qrCode) {
      try {
        const response = await fetch(`${API_URL}/organizers/events/${eventId}/scan-attendance`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ qrCode })
        });

        const data = await response.json();

        if (response.ok) {
          showScanResult('success', `‚úÖ Attendance marked for ${data.participant.name} (${data.participant.ticketId})`);
          playSuccessSound();
          await refreshDashboard();
        } else if (response.status === 400) {
          // Duplicate scan
          showScanResult('duplicate', `‚ö†Ô∏è ${data.message}\n${data.participant.name} was already scanned at ${new Date(data.participant.firstScanTime).toLocaleString()}`);
          playErrorSound();
        } else {
          showScanResult('error', data.message || 'Error scanning QR code');
          playErrorSound();
        }
      } catch (error) {
        showScanResult('error', 'Network error: ' + error.message);
        playErrorSound();
      }
    }

    function showScanResult(type, message) {
      const resultDiv = document.getElementById('scanResult');
      resultDiv.className = `scan-result ${type}`;
      resultDiv.innerHTML = message.replace(/\n/g, '<br>');
      resultDiv.style.display = 'block';

      // Auto-hide after 5 seconds
      setTimeout(() => {
        resultDiv.style.display = 'none';
      }, 5000);
    }

    function playSuccessSound() {
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSh+0fPTgjMGHm7A7+OZUT0NVKvi7thUEgxCq93zxWwlBSZ9zvPWgDMFH2rC8N+SRT0NUq3i7NVXEQ1PrOHzx3EmBSV7zvLWgDMGH2zB8N2RRD4OUKzh79hXEQ1Orn/y0H8sBCWBzvPWgDMFIGy/8N6SRD0NUq3h79ZVEQ5Orn/y0X8sBSWBzvPWgDMFH2y/8N6SRD0NUq3h79ZVEQ5Orp/y0H8sBSWBzvPWgDMFH2y/8N6SRD0NU6zh79hXEQ1Orn/y0H8sBCWBzvPWgDMFH2y/8N6SRD0NUq3h79hXEQ1Orn/y0H8sBSWBzvPWgDMFH2y/8N6RRD0NU6zh79hXEQ1Orn8=');
      audio.volume = 0.3;
      audio.play().catch(() => {});
    }

    function playErrorSound() {
      const audio = new Audio('data:audio/wav;base64,UklGRigBAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQBAAD//wAA//8AAAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//AAAA//8AAP//');
      audio.volume = 0.2;
      audio.play().catch(() => {});
    }

    function toggleManualOverride() {
      const form = document.getElementById('manualOverrideForm');
      form.style.display = form.style.display === 'none' || !form.style.display ? 'block' : 'none';
      
      // Clear form
      document.getElementById('manualTicketId').value = '';
      document.getElementById('manualNotes').value = '';
    }

    async function submitManualAttendance() {
      const ticketId = document.getElementById('manualTicketId').value.trim();
      const notes = document.getElementById('manualNotes').value.trim();

      if (!ticketId || !notes) {
        alert('Please fill in all required fields');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/organizers/events/${eventId}/manual-attendance`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ ticketId, notes })
        });

        const data = await response.json();

        if (response.ok) {
          showScanResult('success', `‚úÖ Manual attendance marked for ${data.participant.name} (${data.participant.ticketId})`);
          toggleManualOverride();
          await refreshDashboard();
        } else {
          alert(data.message || 'Error marking manual attendance');
        }
      } catch (error) {
        alert('Network error: ' + error.message);
      }
    }

    function quickManualMark(ticketId) {
      document.getElementById('manualTicketId').value = ticketId;
      document.getElementById('manualNotes').value = 'Quick mark from not-scanned list';
      document.getElementById('manualOverrideForm').style.display = 'block';
      
      // Scroll to form
      document.getElementById('manualOverrideForm').scrollIntoView({ behavior: 'smooth' });
    }

    async function exportAttendanceCSV() {
      try {
        const response = await fetch(`${API_URL}/organizers/events/${eventId}/export-attendance-csv`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          throw new Error('Failed to export CSV');
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `attendance_${eventId}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);

        showScanResult('success', '‚úÖ Attendance CSV exported successfully');
      } catch (error) {
        alert('Error exporting CSV: ' + error.message);
      }
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        // Stop auto-refresh
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
        }
        // Stop scanner
        if (html5QrCode) {
          stopScanner();
        }
        localStorage.removeItem('token');
        localStorage.removeItem('userType');
        window.location.href = '/auth/login';
      }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
      if (html5QrCode) {
        stopScanner();
      }
    });

    // Load event details on page load
    loadEventDetails();
  </script>
</body>
</html>
